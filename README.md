Для выпускного проекта я выбрал -  Кейс 2: Рекомендации товаров в электронной коммерции
- **Цель:** Предсказать, какие товары предложить пользователю интернет-магазина.
По условиям задачи целевым действием является добавление товара в корзину, в связи с этим я бы предложил следующие бизнес метрики для А/В тестирования эффективности рекомендаций.

### **Бизнес-метрики**

Эти метрики напрямую связаны с бизнес-целями и помогают оценить влияние рекомендательной системы на ключевые показатели:
### a) Конверсия в добавление в корзину (Add-to-Cart Conversion Rate)

Какая доля пользователей, получивших рекомендации, добавила хотя бы один товар в корзину.

Формула:
$$
\text{Add-to-Cart Conversion Rate} = \frac{\text{Количество уникальных пользователей, добавивших товар в корзину}}{\text{Общее количество уникальных пользователей}}
$$

### b) Среднее количество товаров, добавленных в корзину на одного пользователя (Average Items Added per User)

Сколько товаров в среднем добавляет пользователь после взаимодействия с рекомендациями.

Формула:
$$
\text{Average Items Added per User} = \frac{\text{Общее количество товаров, добавленных в корзину}}{\text{Количество уникальных пользователей, добавивших товары}}
$$

### c) Конверсия из добавления в корзину в покупку (Cart-to-Purchase Conversion Rate)

И поскльку рекомендательная система должна приносить выгоду бизнесу, я бы предложил еще одну метрику связанную с продажами.

Какая доля товаров, добавленных в корзину через рекомендации, была куплена.

Формула:
$$
\text{Cart-to-Purchase Conversion Rate} = \frac{\text{Количество уникальных пользователей, совершивших покупку}}{\text{Количество уникальных пользователей, добавивших товар в корзину}}
$$

---

### **Технические метрики** 
В качестве технической метрики я выбрал precision@5, предположив, что релевантные рекомендации положительно повлияют на бизнес-метрики.

### **Технологии** 
Рекомендательная система разрабатывалась на ЯП python.
- Для проведения EDA использовался  jupyter-notebook т.к. это удобный иструмент для визуализации, тестирования гипотез и представления результатов исследования.
- VS Code - IDE для работы с кодом и инраструктурой.
- MLFlow - для логгирования результов
- Библиотека LightFM для построения рекоммендательной системы.
Примечание: Из за особенностей данных, а именно большого количества item'ов, я решил использовать данную библиотеку так как благодоря эмбеддигам получается эффективно сжимать пространство признаков.
- FastAPI - для создания он-лайн сервиса.
- Docker - для контейнерезации вэб сервиса, для дальнейшей продуктивизации, например, на вирутальной машине или  k8s.
- Prometheus - для сбора статистик работы сервиса рекомендаций.
- Grafana - для визуализации метрик работы и оповещения в случае критического уровня ошибок в работе.
- Airflow - для автоматического обучения модели на новых данных, что бы избежать деградации модели и повысить точность рекомендаций используя максимально свежие данные.

### Склонируйте репозиторий

```
https://github.com/AndreyProkofiev/mle-pr-final.git
```

***Создать новое виртуальное окружение можно командой:***

```
python3 -m venv env_recsys_start

```

***Активируйте виртуальное окружение***
```
. env_recsys_start/bin/activate
```

***установите в него необходимые Python-пакеты следующей командой***
```
pip install -r requirements.txt
```

### Тестирование работы сервиса рекомендаций FastAPI

***в терминале зайдите в папку проекта и запустите сервис***

```
cd /fastapi_service/recsys_app

uvicorn recommendations_service:app --reload
```
***в другом терминале запустите тесты***
```
python test_service.py
```
***результаты работы будут сохранены в файл***
```
test_service.log
```
***FastAPI микросервис в Docker-контейнере***

```
cd /fastapi_service
docker image build . --tag myapp  --file Dockerfile_ml_service
docker container run --publish 4600:1702 --env-file .env myapp
```
***Docker compose для микросервиса и системы моониторинга***
```
cd /fastapi_service/
docker compose up --build
```
***В терминале запустить скрипт для тестирования сервиса и сбора статистик***
```
cd /fastapi_service
python mk_simulation.py 
```
Адреса сервисов:

- микросервис: [http://localhost:1702](http://localhost:1702/)
- Prometheus: [http://localhost:9090](http://localhost:9090/)
- Grafana: [http://localhost:3000](http://localhost:3000/)


### Развернуть MLflow
***Запустить можно из терминала выполнив следующие команды:***
```
cd infrastructure/
sh run_mlflow_server.sh
```
***Либо использовать python функцию предварительно импортировав ее***
```
from src.helpers import start_mlflow_server, stop_mlflow_server
```

После запуска необходимо перейти по ссылке http://<your host ip address>:5000 и открыть веб-интерфейс MLflow.
Выбрать эксперемент mle_pr_final, в эксперементе будут завиксированы результаты eda и несколько вариантов обученных lightFM моделей.


### Запустить Airflow


перейдите в папку и выполните в команду в терминале
```
cd airflow_ml_pipeline/
docker compose up --build
```
Когда процесс поднятия будет завершён, у вас появится возможность перейти по ссылке http://<your host ip address>:8080 и открыть веб-интерфейс Airflow. На входе потребуются логин и пароль, вы можете использовать следующие:

- **Логин**: airflow
- **Пароль**: airflow

После того как вы войдёте в учётную запись, перед вами окажется главный экран. Здесь собрана ключевая информация о DAG.


###  Дополнительно
В файле eda_summary.md описаны результаты проведенного разведочного анализа данных.
В фале Monitoring.md - информация по мотирингу.
В фале test_service.log - результаты тестирования FastAPI приложения.


