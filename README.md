
Для выпускного проекта я выбрал **Кейс 2: Рекомендации товаров в электронной коммерции**.

- **Цель:** Предсказать, какие товары предложить пользователю интернет-магазина.
- По условиям задачи целевым действием является добавление товара в корзину. В связи с этим я предлагаю следующие бизнес-метрики для А/В тестирования эффективности рекомендаций.


## **Бизнес-метрики**

Эти метрики напрямую связаны с бизнес-целями и помогают оценить влияние рекомендательной системы на ключевые показатели.

---

### Конверсия в добавление в корзину (Add-to-Cart Conversion Rate)

Какая доля пользователей, получивших рекомендации, добавила хотя бы один товар в корзину.

Формула:

$$
\text{Add-to-Cart Conversion Rate} = \frac{\text{Количество уникальных пользователей, добавивших товар в корзину}}{\text{Общее количество уникальных пользователей}}
$$

---

### Среднее количество товаров, добавленных в корзину на одного пользователя (Average Items Added per User)

Сколько товаров в среднем добавляет пользователь после взаимодействия с рекомендациями.

Формула:

$$
\text{Average Items Added per User} = \frac{\text{Общее количество товаров, добавленных в корзину}}{\text{Количество уникальных пользователей, добавивших товары}}
$$

---

### Конверсия из добавления в корзину в покупку (Cart-to-Purchase Conversion Rate)

Поскольку рекомендательная система должна приносить выгоду бизнесу, я предлагаю еще одну метрику, связанную с продажами.

Какая доля товаров, добавленных в корзину через рекомендации, была куплена.

Формула:

$$
\text{Cart-to-Purchase Conversion Rate} = \frac{\text{Количество уникальных пользователей, совершивших покупку}}{\text{Количество уникальных пользователей, добавивших товар в корзину}}
$$

---

## **Технические метрики**

В качестве технической метрики я выбрал **precision@5**, предположив, что релевантные рекомендации положительно повлияют на бизнес-метрики.

---

## **Технологии**

Рекомендательная система разрабатывалась на ЯП Python.

- Для проведения EDA использовался **Jupyter Notebook**, так как это удобный инструмент для визуализации, тестирования гипотез и представления результатов исследования.
- **VS Code** — IDE для работы с кодом и инфраструктурой.
- **MLFlow** — для логгирования результатов.
- **LightFM** — библиотека для построения рекомендательной системы.
  > Примечание: Из-за особенностей данных (большое количество товаров) я решил использовать данную библиотеку, так как благодаря эмбеддингам удается эффективно сжимать пространство признаков.
- **FastAPI** — для создания онлайн-сервиса.
- **Docker** — для контейнеризации веб-сервиса для дальнейшей продуктивизации, например, на виртуальной машине или Kubernetes.
- **Prometheus** — для сбора статистики работы сервиса рекомендаций.
- **Grafana** — для визуализации метрик работы и оповещения в случае критического уровня ошибок.
- **Airflow** — для автоматического обучения модели на новых данных, чтобы избежать деградации модели и повысить точность рекомендаций, используя максимально свежие данные.

---

## **Инструкции по запуску**

### Склонируйте репозиторий

```bash
https://github.com/AndreyProkofiev/mle-pr-final.git
```

### Создайте новое виртуальное окружение

```bash
python3 -m venv env_recsys_start
```

### Активируйте виртуальное окружение

```bash
. env_recsys_start/bin/activate
```

### Установите необходимые Python-пакеты

```bash
pip install -r requirements.txt
```

---

### Тестирование работы сервиса рекомендаций FastAPI

#### В терминале зайдите в папку проекта и запустите сервис:

```bash
cd /fastapi_service/recsys_app
uvicorn recommendations_service:app --reload
```

#### В другом терминале запустите тесты:

```bash
python test_service.py
```

#### Результаты работы будут сохранены в файл:

```bash
test_service.log
```

---

### FastAPI микросервис в Docker-контейнере

```bash
cd /fastapi_service
docker image build . --tag myapp --file Dockerfile_ml_service
docker container run --publish 4600:1702 --env-file .env myapp
```

---

### Docker Compose для микросервиса и системы мониторинга

```bash
cd /fastapi_service/
docker compose up --build
```

#### В терминале запустите скрипт для тестирования сервиса и сбора статистик:

```bash
cd /fastapi_service
python mk_simulation.py
```

#### Адреса сервисов:

- Микросервис: [http://localhost:1702](http://localhost:1702/)
- Prometheus: [http://localhost:9090](http://localhost:9090/)
- Grafana: [http://localhost:3000](http://localhost:3000/)

---

### Развертывание MLflow

Запустить можно из терминала, выполнив следующие команды:

```bash
cd infrastructure/
sh run_mlflow_server.sh
```

Либо использовать Python-функцию, предварительно импортировав ее:

```python
from src.helpers import start_mlflow_server, stop_mlflow_server
```

После запуска перейдите по ссылке [http://<your host ip address>:5000](http://<your host ip address>:5000) и откройте веб-интерфейс MLflow. Выберите эксперимент `mle_pr_final`, где зафиксированы результаты EDA и несколько вариантов обученных LightFM моделей.

---

### Запуск Airflow

Перейдите в папку и выполните команду в терминале:

```bash
cd airflow_ml_pipeline/
docker compose up --build
```

Когда процесс поднятия будет завершен, вы сможете перейти по ссылке [http://<your host ip address>:8080](http://<your host ip address>:8080) и открыть веб-интерфейс Airflow. На входе потребуются логин и пароль:

- **Логин**: `airflow`
- **Пароль**: `airflow`

---

### Дополнительно

- В файле `eda_summary.md` описаны результаты проведенного разведочного анализа данных.
- В файле `Monitoring.md` — информация по мониторингу.
- В файле `test_service.log` — результаты тестирования FastAPI приложения.

---


